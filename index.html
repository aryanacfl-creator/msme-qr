<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
<meta http-equiv="Pragma" content="no-cache" />
<title>MSME QR Redirect</title>
<style>
  :root{color-scheme:light dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
  code,pre{background:#f6f8fa;padding:2px 4px;border-radius:4px}
  a{word-break:break-all}
  .muted{color:#666}
</style>
<body>
<div id="out">Redirecting…</div>
<script>
(async function () {
  const out = document.getElementById('out');
  const href = String(location.href || '');
  const url  = new URL(href);

  // 1) Read SID from hash (recommended):  https://your-pages-site/#MSME00001
  // 2) Fallback to query:                 https://your-pages-site/?sid=MSME00001
  let sid = (location.hash || '').replace(/^#/, '');
  if (!sid) sid = url.searchParams.get('sid') || '';
  sid = sid.toUpperCase().trim();

  const debug = url.searchParams.has('debug');

  // Load current form base from config.json (must end with "=")
  let cfg;
  try {
    const res = await fetch('config.json?v=' + Date.now(), { cache: 'no-store' });
    cfg = await res.json();
  } catch (e) {
    out.innerHTML = `<p>Failed to load <code>config.json</code>: ${String(e)}</p>`;
    return;
  }

  const base = String(cfg.FORM_PREFILL_BASE || '');
  if (!base.endsWith('=')) {
    out.innerHTML = `<p><code>FORM_PREFILL_BASE</code> in <code>config.json</code> must end with <code>=</code>.</p>`;
    return;
  }

  // Strict format: MSME + 5 digits
  const ok = /^MSME\d{5}$/.test(sid);
  if (!ok) {
    const eg = 'MSME00001';
    out.innerHTML = `
      <h3>Invalid or missing SID</h3>
      <p>Expected format: <b>MSME00001…MSME99999</b></p>
      <p>Use one of these URL shapes:</p>
      <ul>
        <li><code>${location.origin + location.pathname}#${eg}</code> <span class="muted">(recommended)</span></li>
        <li><code>${location.origin + location.pathname}?sid=${eg}</code></li>
      </ul>
      <pre>href: ${href.replace(/</g,'&lt;')}</pre>`;
    return;
  }

  const target = base + encodeURIComponent(sid);

  if (debug) {
    out.innerHTML = `
      <h3>DEBUG</h3>
      <div>SID: <code>${sid}</code></div>
      <div>Target:<br><a href="${target}" target="_blank">${target}</a></div>
      <pre>href: ${href.replace(/</g,'&lt;')}</pre>`;
    return;
  }

  try { location.replace(target); } catch (e) { location.href = target; }
})();
</script>
</body>
</html>
